{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="min-h-screen bg-slate-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
        <!-- Breadcrumbs -->
        <nav class="flex mb-8 items-center gap-2 text-[10px] font-bold uppercase tracking-widest text-slate-400">
            <a href="{% url 'document_management:registry' %}" class="hover:text-nigeria-green">Registry</a>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
            <a href="{{ file.get_absolute_url }}" class="hover:text-nigeria-green">{{ file.file_number }}</a>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg>
            <span class="text-slate-900">Add Entry</span>
        </nav>

        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
            <!-- Header -->
            <div class="p-8 lg:p-10 bg-slate-900 text-white relative overflow-hidden">
                <div class="relative z-10">
                    <h1 class="text-2xl font-black uppercase tracking-tighter mb-2">New Chronicle Entry</h1>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-nigeria-green"></span>
                        File Reference: {{ file.file_number }}
                    </p>
                </div>
                <!-- Abstract Design Elements -->
                <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-32 -mt-32 blur-3xl"></div>
                <div class="absolute bottom-0 left-0 w-32 h-32 bg-nigeria-green/10 rounded-full -ml-16 -mb-16 blur-2xl"></div>
            </div>

            <div class="p-8 lg:p-10">
                <form method="post" enctype="multipart/form-data" class="space-y-8">
                    {% csrf_token %}

                    {% if parent_doc %}
                    <!-- Replying to Context -->
                    <div class="p-4 bg-indigo-50 border border-indigo-100 rounded-xl flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-[9px] font-black text-white bg-indigo-600 px-2 py-1 rounded uppercase shadow-sm">Response to Dispatch</span>
                            <div>
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Replying to Action on</p>
                                <p class="text-xs font-bold text-indigo-900">{{ parent_doc.title|default:"Minute Entry" }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% for field in form %}
                    <div class="space-y-3">
                        {% if field.name != 'parent' %}
                        
                        {% if field.name == 'include_signature' %}
                        <!-- Enhanced Signature Section -->
                        <div x-data="{ signed: false }" class="p-6 bg-slate-50 border border-slate-200 rounded-2xl transition-all" :class="signed ? 'bg-nigeria-light/30 border-nigeria-green/30' : ''">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="flex items-center h-5">
                                        <input id="{{ field.id_for_label }}" name="{{ field.name }}" type="checkbox" x-model="signed"
                                            class="w-5 h-5 text-nigeria-green border-slate-300 rounded focus:ring-nigeria-green transition-all cursor-pointer">
                                    </div>
                                    <label for="{{ field.id_for_label }}" class="text-xs font-black text-slate-900 uppercase tracking-widest cursor-pointer">
                                        {{ field.label }}
                                    </label>
                                </div>
                                
                                <div x-show="signed" x-cloak class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-nigeria-green animate-pulse"></span>
                                    <span class="text-[9px] font-black text-nigeria-green uppercase tracking-widest">Active Certificate Linked</span>
                                </div>
                            </div>

                            <div x-show="signed" x-cloak 
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 -translate-y-2"
                                 x-transition:enter-end="opacity-100 translate-y-0"
                                 class="mt-6 pt-6 border-t border-slate-200/50">
                                
                                <div class="flex flex-col md:flex-row items-center gap-6">
                                    {% if active_signature %}
                                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm relative group overflow-hidden">
                                        <!-- Protective Overlay to discourage simple drag/drop -->
                                        <div class="absolute inset-0 z-10 bg-transparent cursor-default" @contextmenu.prevent></div>
                                        <img src="{{ active_signature.image.url }}" alt="Verified Signature" class="h-16 w-auto grayscale pointer-events-none">
                                        <div class="absolute inset-0 bg-slate-900/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none flex items-center justify-center">
                                            <span class="text-[8px] font-black text-white bg-slate-900/80 px-2 py-1 rounded uppercase tracking-tighter">Verified Identity</span>
                                        </div>
                                    </div>
                                    <div class="flex-1 text-center md:text-left">
                                        <p class="text-[10px] font-black text-slate-900 uppercase tracking-widest mb-1">{{ user.get_full_name|default:user.username }}</p>
                                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-2">{{ user.staff.designation.name }}</p>
                                        <div class="flex items-center gap-1.5 justify-center md:justify-start">
                                            <svg class="w-3 h-3 text-nigeria-green" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                            </svg>
                                            <span class="text-[8px] font-black text-nigeria-green uppercase tracking-widest">Digitally Authenticated</span>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="flex-1 p-4 bg-amber-50 border border-amber-100 rounded-xl">
                                        <p class="text-[10px] font-bold text-amber-800 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                            No active signature found in your profile. 
                                            <a href="{% url 'user_management:profile' %}" class="underline font-black">Upload one now</a>
                                        </p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <label for="{{ field.id_for_label }}" class="block text-xs font-black text-slate-900 uppercase tracking-widest">
                            {{ field.label }}
                        </label>
                        
                        <div class="relative group">
                            {% if field.name == 'minute_content' %}
                                {{ field|add_class:"form-control summernote" }}
                            {% elif field.name == 'attachment' %}
                                <div class="relative flex items-center">
                                    {{ field|add_class:"block w-full text-sm text-slate-500 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-[10px] file:font-black file:uppercase file:tracking-widest file:bg-slate-900 file:text-white hover:file:bg-black transition-all cursor-pointer" }}
                                </div>
                            {% else %}
                                {{ field|add_class:"block w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-nigeria-green focus:bg-white outline-none transition-all font-medium placeholder:text-slate-400" }}
                            {% endif %}
                            
                            {% if field.help_text %}
                            <p class="mt-2 text-[10px] text-slate-400 font-bold uppercase tracking-wider leading-relaxed italic">{{ field.help_text }}</p>
                            {% endif %}
                        </div>

                        {% for error in field.errors %}
                        <p class="text-[10px] text-red-600 font-black uppercase tracking-widest mt-1 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            {{ error }}
                        </p>
                        {% endfor %}
                        {% endif %}
                        {% endif %}
                    </div>
                    {% endfor %}

                    <div class="pt-6 border-t border-slate-100 flex flex-col sm:flex-row gap-4">
                        <button type="submit" class="flex-1 py-4 bg-nigeria-green hover:bg-nigeria-dark text-white text-xs font-black uppercase tracking-widest rounded-xl shadow-lg transition-all hover:-translate-y-0.5 active:translate-y-0">
                            Validate & Commit to Chronicle
                        </button>
                        <a href="{{ file.get_absolute_url }}" class="px-8 py-4 bg-white border border-slate-200 text-slate-600 text-xs font-black uppercase tracking-widest rounded-xl hover:bg-slate-50 transition-all text-center">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <p class="mt-8 text-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">
            Sovereign Personnel Record System â€¢ Authorization Required
        </p>
    </div>
</div>

<!-- Summernote CSS/JS & Improved Styling -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

<style>
    /* Gmail-like Summernote Styling */
    .note-editor.note-frame {
        border: 1px solid #e2e8f0 !important;
        border-radius: 0.75rem !important;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1) !important;
        background: white !important;
    }
    
    .note-toolbar {
        background: #f8fafc !important;
        border-bottom: 1px solid #e2e8f0 !important;
        border-radius: 0.75rem 0.75rem 0 0 !important;
        padding: 8px 12px !important;
    }
    
    .note-editable {
        font-family: 'Inter', sans-serif !important;
        font-size: 14px !important;
        line-height: 1.6 !important;
        padding: 20px !important;
        min-height: 300px !important;
        color: #1e293b !important;
    }
    
    .note-btn-group .note-btn {
        background: white !important;
        border: 1px solid #e2e8f0 !important;
        margin: 0 2px !important;
        padding: 6px 10px !important;
        border-radius: 6px !important;
        transition: all 0.2s !important;
        color: #475569 !important;
    }
    
    .note-btn-group .note-btn:hover {
        background: #f1f5f9 !important;
        border-color: #cbd5e1 !important;
        color: #0f172a !important;
    }
    
    .note-btn-group .note-btn.active {
        background: #008751 !important;
        color: white !important;
        border-color: #008751 !important;
    }

    .note-placeholder {
        padding: 20px !important;
        font-style: normal !important;
        color: #94a3b8 !important;
    }
</style>

<!-- Summernote Initialization -->
<script>
    $(document).ready(function() {
        $('.summernote').summernote({
            height: 350,
            placeholder: 'Compose your content here... You can use formatting, lists, and tables to structure your entry.',
            tabsize: 2,
            toolbar: [
                ['style', ['bold', 'italic', 'underline', 'clear']],
                ['font', ['strikethrough', 'superscript', 'subscript']],
                ['fontsize', ['fontsize']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['height', ['height']],
                ['insert', ['link', 'table', 'hr']],
                ['view', ['fullscreen', 'codeview']]
            ],
            fontSizes: ['10', '12', '14', '16', '18', '20', '24'],
            callbacks: {
                onInit: function() {
                    // Modernize the interface further
                    $('.note-status-output').remove();
                }
            }
        });
    });
</script>
{% endblock %}
