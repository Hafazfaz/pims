{% extends 'base.html' %}

{% block title %}Registry Dashboard{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-md">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Registry Dashboard</h2>
        <a href="{% url 'document_management:file_create' %}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Create New File</a>
    </div>

    <form method="get" class="mb-6 border-b pb-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div>
                <label for="id_q" class="block text-sm font-medium text-gray-700">Search</label>
                <input type="text" name="q" id="id_q" value="{{ selected_search_query }}" placeholder="Title or File No." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div>
                <label for="id_file_type" class="block text-sm font-medium text-gray-700">File Type</label>
                <select name="file_type" id="id_file_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All Types</option>
                    {% for type_val, type_label in all_file_types %}
                        <option value="{{ type_val }}" {% if selected_file_type == type_val %}selected{% endif %}>{{ type_label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="id_status" class="block text-sm font-medium text-gray-700">Status</label>
                <select name="status" id="id_status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All Statuses</option>
                    {% for status_val, status_label in all_statuses %}
                        <option value="{{ status_val }}" {% if selected_status == status_val %}selected{% endif %}>{{ status_label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="id_owner" class="block text-sm font-medium text-gray-700">Owner</label>
                <select name="owner" id="id_owner" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All Owners</option>
                    {% for owner_obj in all_owners_in_unit %}
                        <option value="{{ owner_obj.pk }}" {% if selected_owner|stringformat:"s" == owner_obj.pk|stringformat:"s" %}selected{% endif %}>{{ owner_obj.user.username }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label for="id_current_location" class="block text-sm font-medium text-gray-700">Current Location</label>
                <select name="current_location" id="id_current_location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All Locations</option>
                    {% for location_obj in all_locations_in_unit %}
                        <option value="{{ location_obj.pk }}" {% if selected_current_location|stringformat:"s" == location_obj.pk|stringformat:"s" %}selected{% endif %}>{{ location_obj.user.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="id_start_date" class="block text-sm font-medium text-gray-700">Created From</label>
                <input type="date" name="start_date" id="id_start_date" value="{{ selected_start_date }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            <div>
                <label for="id_end_date" class="block text-sm font-medium text-gray-700">Created To</label>
                <input type="date" name="end_date" id="id_end_date" value="{{ selected_end_date }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
        </div>
        <div class="flex items-center">
            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Apply Filters</button>
            <a href="{% url 'document_management:registry_dashboard' %}" class="ml-2 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Reset Filters</a>
        </div>
    </form>

    {# Pending Activation Requests Section #}
    {% if pending_activation_files %}
    <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Pending Activation Requests</h3>
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3">File Number</th>
                    <th scope="col" class="px-6 py-3">Title</th>
                    <th scope="col" class="px-6 py-3">Type</th>
                    <th scope="col" class="px-6 py-3">Department</th>
                    <th scope="col" class="px-6 py-3">Owner</th>
                    <th scope="col" class="px-6 py-3">Requested At</th>
                    <th scope="col" class="px-6 py-3">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for file in pending_activation_files %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.file_number }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.title }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.get_file_type_display }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.department.name|default:"N/A" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.owner.get_full_name|default:file.owner.user.username }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.created_at|date:"Y-m-d H:i" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <form action="{% url 'document_management:file_approve_activation' pk=file.pk %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Approve Activation</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mt-4" role="alert">
        <p>No pending activation requests.</p>
    </div>
    {% endif %}

    {# All Files Section #}
    <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4">All Files</h3>
    {% if files %}
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-500">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3">File Number</th>
                    <th scope="col" class="px-6 py-3">Title</th>
                    <th scope="col" class="px-6 py-3">Type</th>
                    <th scope="col" class="px-6 py-3">Department</th>
                    <th scope="col" class="px-6 py-3">Status</th>
                    <th scope="col" class="px-6 py-3">Owner</th>
                    <th scope="col" class="px-6 py-3">Current Location</th>
                    <th scope="col" class="px-6 py-3">Created At</th>
                    <th scope="col" class="px-6 py-3">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for file in files %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.file_number }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.title }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.get_file_type_display }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.department.name|default:"N/A" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.get_status_display }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.owner.get_full_name|default:file.owner.user.username }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.current_location.get_full_name|default:file.current_location.user.username }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ file.created_at|date:"Y-m-d H:i" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="{% url 'document_management:file_detail' pk=file.pk %}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">View</a>
                        <a href="#" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">Edit</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4" role="alert">
        <p>No files found in the system.</p>
    </div>
    {% endif %}
</div>
{% endblock %}